<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 | Velotric 培训游戏</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="admin-container">
        <!-- ===== 登录界面 ===== -->
        <section id="login-screen" class="admin-screen active">
            <div class="login-card">
                <div class="login-icon">🔐</div>
                <h1>管理后台</h1>
                <p class="login-desc">请输入管理密码以进入配置页面</p>
                <div class="login-form">
                    <input type="password" id="password-input" class="password-input" placeholder="请输入密码"
                        autocomplete="off">
                    <button id="login-btn" class="btn btn-primary">进入管理</button>
                </div>
                <p class="login-error" id="login-error" style="display: none;">密码错误，请重试</p>
                <a href="index.html" class="back-link">← 返回游戏</a>
            </div>
        </section>

        <!-- ===== 管理主界面 ===== -->
        <section id="admin-screen" class="admin-screen">
            <header class="admin-header">
                <h1>🛠️ 题目管理中心</h1>
                <div class="header-actions">
                    <a href="admin/dashboard.html" class="btn btn-primary" style="margin-right: 10px;">📊 数据看板</a>
                    <button id="preview-btn" class="btn btn-secondary">👁️ 预览游戏</button>
                    <button id="logout-btn" class="btn btn-secondary">🚪 退出</button>
                </div>
            </header>

            <!-- 标签页导航 -->
            <nav class="admin-tabs">
                <button class="tab-btn active" data-tab="story">🎬 剧情编辑</button>
                <button class="tab-btn" data-tab="knowledge">📚 知识库</button>
                <button class="tab-btn" data-tab="difficulty">⚙️ 难度设置</button>
                <button class="tab-btn" data-tab="announcements">📢 公告管理</button>
            </nav>

            <!-- 🎬 剧情编辑器面板 -->
            <div id="story-panel" class="admin-panel active">
                <div class="panel-header">
                    <div class="chapter-selector">
                        <label>编辑章节：</label>
                        <select id="story-chapter-select">
                            <!-- 动态生成 -->
                        </select>
                    </div>
                    <div class="header-actions">
                        <button id="add-node-btn" class="btn btn-secondary">➕ 添加节点</button>
                        <button id="chapter-settings-btn" class="btn btn-secondary">⚙️ 章节属性</button>
                        <button id="validate-btn" class="btn btn-secondary">🔍 校验</button>
                        <button id="preview-story-btn" class="btn btn-secondary">▶️ 预览</button>
                        <button id="view-toggle-btn" class="btn btn-secondary" title="切换列表/图谱视图">🗺️ 图谱</button>
                        <button id="theme-toggle" class="btn btn-secondary" title="切换深色/浅色模式">🌓</button>
                        <button id="save-story-btn" class="btn btn-primary">💾 保存</button>
                        <button id="export-story-btn" class="btn btn-secondary">📤 导出</button>
                        <button id="import-story-btn" class="btn btn-secondary">📥 导入</button>
                        <input type="file" id="import-file-input" accept=".json" style="display:none">
                    </div>
                </div>
                <div class="story-editor-container">
                    <!-- 左侧：节点列表/大纲 -->
                    <div class="story-sidebar">
                        <div class="sidebar-header">节点列表</div>
                        <div id="node-list" class="node-list">
                            <!-- 动态生成 -->
                        </div>
                    </div>
                    <!-- 中间：画布/预览 -->
                    <div class="story-canvas" id="story-canvas">
                        <div class="canvas-placeholder">请选择一个节点进行编辑</div>
                    </div>
                    <!-- 右侧：属性编辑 -->
                    <div class="story-properties" id="node-properties" style="display: none;">
                        <h3>节点属性</h3>
                        <div class="form-group">
                            <label>节点 ID</label>
                            <input type="text" id="node-id" readonly>
                        </div>
                        <div class="form-group">
                            <label>发言人</label>
                            <input type="text" id="node-speaker">
                        </div>
                        <div class="form-group">
                            <label>头像 Emoji</label>
                            <input type="text" id="node-avatar">
                        </div>
                        <div class="form-group">
                            <label>对白内容</label>
                            <textarea id="node-text" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>触发事件 (可选)</label>
                            <input type="text" id="node-event" placeholder="例如: show_map">
                        </div>
                        <div class="form-group">
                            <label>解锁知识卡 (可选)</label>
                            <select id="node-unlock-card">
                                <option value="">(无)</option>
                                <!-- 动态生成 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>跳转至 (Next Node)</label>
                            <select id="node-next">
                                <option value="">(无 / 结束)</option>
                            </select>
                        </div>

                        <div id="choices-section">
                            <h3>选项设定</h3>
                            <div id="node-choices-list">
                                <!-- 动态生成 -->
                            </div>
                            <button id="add-choice-btn" class="btn btn-secondary btn-sm" style="width:100%">+
                                添加选项</button>
                        </div>

                        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
                            <button id="delete-node-btn" class="btn btn-danger btn-sm" style="width:100%">🗑️
                                删除当前节点</button>
                        </div>
                    </div>
                </div>

                <!-- 章节属性弹窗 -->
                <div class="knowledge-popup" id="chapter-settings-modal" style="display: none;">
                    <div class="knowledge-card" style="width: 500px; max-width: 90%;">
                        <div class="card-header">
                            <span class="card-icon">⚙️</span>
                            <span class="card-label">章节属性设置</span>
                            <button class="btn-close" id="close-chapter-settings-btn"
                                style="margin-left:auto; background:none; border:none; font-size:20px; cursor:pointer;">×</button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label>章节标题</label>
                                <input type="text" id="chapter-title-input">
                            </div>
                            <div class="form-group">
                                <label>章节描述</label>
                                <textarea id="chapter-desc-input" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>解锁条件 (上一章ID)</label>
                                <input type="number" id="chapter-unlock-input">
                            </div>
                            <div class="form-group">
                                <label>封面图片 (Emoji 或 URL)</label>
                                <input type="text" id="chapter-cover-input">
                            </div>
                            <div style="margin-top: 20px; text-align: right;">
                                <button class="btn btn-secondary" id="cancel-chapter-settings-btn">取消</button>
                                <button class="btn btn-primary" id="save-chapter-settings-btn">保存配置</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 难度设置面板 -->
            <div id="difficulty-panel" class="admin-panel">
                <div class="difficulty-cards">
                    <!-- 新人模式 -->
                    <div class="difficulty-card">
                        <div class="difficulty-header easy">
                            <span class="difficulty-icon">🟢</span>
                            <h3>新人模式</h3>
                        </div>
                        <div class="difficulty-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="easy-retry" checked>
                                <span>答错可重选</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="easy-hint" checked>
                                <span>显示正确答案提示</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="easy-timer" disabled>
                                <span>限时作答</span>
                            </label>
                            <div class="score-multiplier">
                                <label>得分倍率：</label>
                                <input type="number" id="easy-multiplier" value="1" min="0.5" max="3" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- 标准模式 -->
                    <div class="difficulty-card">
                        <div class="difficulty-header normal">
                            <span class="difficulty-icon">🟡</span>
                            <h3>标准模式</h3>
                        </div>
                        <div class="difficulty-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="normal-retry">
                                <span>答错可重选</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="normal-hint">
                                <span>显示正确答案提示</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="normal-timer">
                                <span>限时作答</span>
                            </label>
                            <div class="score-multiplier">
                                <label>得分倍率：</label>
                                <input type="number" id="normal-multiplier" value="1" min="0.5" max="3" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- 挑战模式 -->
                    <div class="difficulty-card">
                        <div class="difficulty-header hard">
                            <span class="difficulty-icon">🔴</span>
                            <h3>挑战模式</h3>
                        </div>
                        <div class="difficulty-options">
                            <label class="checkbox-label">
                                <input type="checkbox" id="hard-retry">
                                <span>答错可重选</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="hard-hint">
                                <span>显示正确答案提示</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="hard-timer" checked>
                                <span>限时作答</span>
                            </label>
                            <div class="time-limit">
                                <label>限时秒数：</label>
                                <input type="number" id="hard-time-limit" value="15" min="5" max="60">
                            </div>
                            <div class="score-multiplier">
                                <label>得分倍率：</label>
                                <input type="number" id="hard-multiplier" value="1.5" min="0.5" max="3" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel-actions">
                    <button id="save-difficulty-btn" class="btn btn-primary">💾 保存设置</button>
                    <button id="reset-difficulty-btn" class="btn btn-secondary">↩️ 恢复默认</button>
                </div>
            </div>



            <!-- 📚 知识库面板 -->
            <div id="knowledge-panel" class="admin-panel">
                <div class="panel-header">
                    <h3>知识卡片管理</h3>
                    <div class="header-actions">
                        <button id="add-card-btn" class="btn btn-secondary">➕ 新增卡片</button>
                        <button id="save-cards-btn" class="btn btn-primary">💾 保存知识库</button>
                    </div>
                </div>
                <div class="knowledge-container">
                    <div class="card-list" id="knowledge-list">
                        <!-- 动态生成 -->
                    </div>
                    <div class="card-editor" id="card-editor" style="display: none;">
                        <h3>编辑卡片</h3>
                        <div class="form-group">
                            <label>卡片 ID (唯一标识)</label>
                            <input type="text" id="card-id-input">
                        </div>
                        <div class="form-group">
                            <label>标题</label>
                            <input type="text" id="card-title-input">
                        </div>
                        <div class="form-group">
                            <label>内容描述</label>
                            <textarea id="card-content-input" rows="6"></textarea>
                        </div>
                        <button id="delete-card-btn" class="btn btn-danger">🗑️ 删除卡片</button>
                    </div>
                </div>
            </div>

            <!-- 章节配置面板 -->
            <div id="chapters-panel" class="admin-panel">
                <div class="chapters-list" id="chapters-list">
                    <!-- 动态生成章节列表 -->
                </div>
                <div class="panel-actions">
                    <button id="add-chapter-btn" class="btn btn-secondary">➕ 添加章节</button>
                    <button id="save-chapters-btn" class="btn btn-primary">💾 保存章节</button>
                    <button id="reset-chapters-btn" class="btn btn-secondary">↩️ 恢复默认</button>
                </div>
            </div>

            <!-- 📢 公告管理面板 -->
            <div id="announcements-panel" class="admin-panel">
                <div class="panel-header">
                    <h3>公告管理</h3>
                    <div class="header-actions">
                        <button id="add-announcement-btn" class="btn btn-secondary">➕ 新增公告</button>
                        <button id="refresh-announcements-btn" class="btn btn-secondary">🔄 刷新</button>
                    </div>
                </div>
                <div class="ann-container">
                    <div class="ann-list" id="admin-announcement-list">
                        <!-- 动态生成 -->
                    </div>
                    <div class="ann-editor" id="announcement-editor" style="display: none;">
                        <div class="ann-editor-toolbar">
                            <h3 id="announcement-editor-title">编辑公告</h3>
                            <div class="ann-editor-actions">
                                <button id="save-announcement-btn" class="btn btn-primary btn-sm">💾 保存</button>
                                <button id="delete-announcement-btn" class="btn btn-danger btn-sm" style="display:none;">🗑️ 删除</button>
                                <button id="cancel-announcement-btn" class="btn btn-secondary btn-sm">取消</button>
                            </div>
                        </div>
                        <div class="ann-editor-body">
                            <div class="form-group">
                                <label>标题</label>
                                <input type="text" id="ann-title-input" placeholder="公告标题">
                            </div>
                            <div class="form-group">
                                <label>内容 (支持简易 Markdown：**粗体** / - 列表 / ## 标题)</label>
                                <textarea id="ann-content-input" rows="10" placeholder="在这里输入公告内容..."></textarea>
                            </div>
                            <div class="ann-editor-row">
                                <div class="form-group" style="flex:1;">
                                    <label>排序 (越小越靠前)</label>
                                    <input type="number" id="ann-sort-input" value="0" min="0">
                                </div>
                                <div class="form-group" style="flex:1;">
                                    <label class="checkbox-label" style="margin-top: 8px;">
                                        <input type="checkbox" id="ann-active-input" checked>
                                        <span>启用 (显示在首页)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="ann-preview-box">
                                <h4>实时预览</h4>
                                <div class="ann-preview-content" id="ann-preview-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 对话预览弹窗 -->
            <div class="story-preview-modal" id="story-preview-modal" style="display: none;">
                <div class="story-preview-content">
                    <div class="story-preview-header">
                        <h3>▶️ 对话预览</h3>
                        <button class="btn-close" id="close-preview-btn">×</button>
                    </div>
                    <div class="story-preview-scene">
                        <div class="preview-speaker-area">
                            <div class="preview-speaker-avatar" id="preview-avatar">👤</div>
                            <div class="preview-speaker-name" id="preview-speaker">???</div>
                        </div>
                        <div class="preview-dialog-text" id="preview-text">对话内容</div>
                        <div class="preview-node-id" id="preview-node-indicator">node: start</div>
                        <div class="preview-choices-area" id="preview-choices">
                            <!-- 动态生成 -->
                        </div>
                        <button class="btn btn-primary preview-next-btn" id="preview-next-btn">继续 →</button>
                    </div>
                </div>
            </div>

            <!-- 校验结果弹窗 -->
            <div class="validate-modal" id="validate-modal" style="display: none;">
                <div class="validate-content">
                    <div class="validate-header">
                        <h3>🔍 脚本校验结果</h3>
                        <button class="btn-close" id="close-validate-btn">×</button>
                    </div>
                    <div class="validate-body" id="validate-body">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 状态提示 -->
            <div class="toast" id="toast" style="display: none;">
                <span class="toast-message" id="toast-message">保存成功</span>
            </div>
        </section>
    </div>

    <script src="config.js"></script>
    <script src="core/StoryLoader.js"></script>
    <script src="core/AnnouncementManager.js"></script>
    <script src="admin_knowledge.js"></script>
    <script src="admin_announcements.js"></script>
    <script src="admin_story.js"></script>
    <script src="admin_theme.js"></script>
    <script src="admin.js"></script>
</body>

</html>