<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®çœ‹æ¿ | Velotric æ¸¸æˆåˆ†æ</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        html,
        body {
            overflow-y: auto !important;
            height: auto !important;
            min-height: 100vh;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 50px;
            /* Ensure space at bottom */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-sm);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .chart-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            margin-bottom: 20px;
            height: 400px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }

        .data-table th {
            background: var(--bg-elevated);
            font-weight: 600;
        }

        .btn-refresh {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="header">
            <div>
                <h1>ğŸ“Š æ¸¸æˆæ•°æ®çœ‹æ¿</h1>
                <p>Local Development Mode</p>
            </div>
            <div>
                <button class="btn-refresh" onclick="renderDashboard()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn btn-secondary" onclick="simulateData()">ğŸ§ª æ¨¡æ‹Ÿæ•°æ®</button>
                <button id="theme-toggle" class="btn btn-secondary" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">ğŸŒ“</button>
                <button class="btn btn-secondary" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæœ¬åœ°</button>
                <button class="btn btn-secondary" style="background:#dc3545" onclick="clearRemoteData()">â˜ï¸
                    æ¸…ç©ºè¿œç¨‹</button>
                <a href="../index.html" class="btn btn-ghost">è¿”å›æ¸¸æˆ</a>
            </div>
        </header>

        <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
        <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
        <div class="stats-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="stat-card">
                <div class="stat-label">æ€»æµè§ˆé‡ (PV)</div>
                <div class="stat-value" id="pv-count">0</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Total Events</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç‹¬ç«‹è®¿å®¢ (UV)</div>
                <div class="stat-value" id="uv-count">0</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Unique Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¯åŠ¨æ¬¡æ•°</div>
                <div class="stat-value" id="launch-count">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">é€šå…³ç‡ (Pass Rate)</div>
                <div class="stat-value" id="pass-rate">0%</div>
                <div style="font-size: 12px; color: var(--text-secondary);">Completes / Starts</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <!-- è½¬åŒ–æ¼æ–— (å æ»¡æ•´è¡Œ) -->
            <div class="chart-container" style="grid-column: 1 / -1;">
                <h3>ç©å®¶è½¬åŒ–æ¼æ–— (Conversion Funnel)</h3>
                <canvas id="funnelChart" style="max-height: 300px;"></canvas>
            </div>
            <div class="chart-container">
                <h3>ç« èŠ‚æ´»è·ƒåº¦</h3>
                <canvas id="chapterChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>äº‹ä»¶åˆ†å¸ƒ</h3>
                <canvas id="eventPieChart"></canvas>
            </div>
        </div>

        <!-- æœ€è¿‘äº‹ä»¶åˆ—è¡¨ -->
        <div class="chart-container" style="height: auto; overflow-x: auto;">
            <h3>æœ€è¿‘å®æ—¶äº‹ä»¶ (Latest 20)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>äº‹ä»¶ç±»å‹</th>
                        <th>Session ID</th>
                        <th>è¯¦æƒ…</th>
                    </tr>
                </thead>
                <tbody id="event-log-body">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="../core/AnalyticsManager.js"></script>
    <script src="../admin_theme.js"></script>
    <script>
        // ç®€å•çš„ Mock 
        const Analytics = AnalyticsManager;

        // åˆå§‹åŒ– Analytics (è§¦å‘ Supabase è¿æ¥)
        Analytics.init();

        async function renderDashboard() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const tbody = document.getElementById('event-log-body');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Loading data from Supabase...</td></tr>';

            // è·å–è¿œç¨‹æ•°æ®
            let data = await Analytics.getRemoteData();

            // å¦‚æœæ²¡æœ‰è¿œç¨‹æ•°æ®ï¼ˆæˆ–å‡ºé”™ï¼‰ï¼Œå›é€€åˆ°æœ¬åœ°
            if (!data || data.length === 0) {
                console.log('No remote data, using local fallback');
                data = Analytics.getLocalData().reverse();
                document.querySelector('.header p').textContent = 'Local Development Mode (Remote Unavailable)';
            } else {
                document.querySelector('.header p').textContent = 'Remote Data Mode (Supabase Connected)';
            }

            // 1. æ›´æ–°å¡ç‰‡
            // PV: page_view acts (approx by game_launch or just total events, let's use game_launch as session start)
            const launches = data.filter(e => e.event === 'game_launch').length;
            const uniqueUsers = new Set(data.map(e => e.user_id)).size;
            const gameCompletes = data.filter(e => e.event === 'game_complete').length;

            document.getElementById('pv-count').textContent = data.length; // Total Events
            document.getElementById('uv-count').textContent = uniqueUsers; // Unique Users
            document.getElementById('launch-count').textContent = launches;

            // Pass Rate
            const passRate = launches > 0 ? ((gameCompletes / launches) * 100).toFixed(1) : 0;
            document.getElementById('pass-rate').textContent = `${passRate}%`;



            // 2. æ›´æ–°è¡¨æ ¼
            tbody.innerHTML = '';
            data.slice(0, 20).forEach(e => {
                const tr = document.createElement('tr');
                const ts = e.timestamp || e.client_timestamp;
                const time = ts ? new Date(ts).toLocaleTimeString() : 'N/A';

                // æ ¼å¼åŒ–è¯¦æƒ…
                let details = '';
                const excludeKeys = ['event', 'sessionId', 'userId', 'timestamp', '_id', 'event_name', 'session_id', 'user_id', 'client_timestamp', 'properties'];
                Object.keys(e).forEach(k => {
                    if (!excludeKeys.includes(k) && e[k] !== undefined) {
                        details += `${k}: ${e[k]} | `;
                    }
                });

                const fullSessionId = e.sessionId || e.session_id || 'N/A';
                tr.innerHTML = `
                    <td>${time}</td>
                    <td><span style="font-weight:bold; color:var(--primary)">${e.event}</span></td>
                    <td style="font-family:monospace; font-size:0.8em">
                        <span title="${fullSessionId}" style="cursor:help; border-bottom:1px dashed #999;">
                            ${fullSessionId.substring(0, 12)}...
                        </span>
                    </td>
                    <td style="font-size:0.9em; color:var(--text-secondary); white-space: pre-wrap;">${details}</td>
                `;
                tbody.appendChild(tr);
            });

            // 3. æ¸²æŸ“å›¾è¡¨
            renderCharts(data);
        }

        let chapterChartInst = null;
        let pieChartInst = null;
        let funnelChartInst = null;

        function renderCharts(data) {
            // --- 1. Funnel Data ---
            // Steps: Launch -> Chapter 1 Start -> Chapter 1 Complete -> Game Complete
            const uniqueSessions = new Set(data.map(e => e.session_id || e.sessionId));
            const funnelCounts = {
                launch: uniqueSessions.size, // Approximation: All unique sessions
                chap1_start: new Set(data.filter(e => e.event === 'chapter_start' && e.chapter_id == 1).map(e => e.session_id || e.sessionId)).size,
                chap1_end: new Set(data.filter(e => e.event === 'chapter_complete' && e.chapter_id == 1).map(e => e.session_id || e.sessionId)).size,
                game_end: new Set(data.filter(e => e.event === 'game_complete').map(e => e.session_id || e.sessionId)).size
            };

            const ctxFunnel = document.getElementById('funnelChart').getContext('2d');
            if (funnelChartInst) funnelChartInst.destroy();

            funnelChartInst = new Chart(ctxFunnel, {
                type: 'bar',
                data: {
                    labels: ['æ¸¸æˆå¯åŠ¨ (Launch)', 'å¼€å§‹ç¬¬1ç« ', 'å®Œæˆç¬¬1ç« ', 'é€šå…³ (Game Complete)'],
                    datasets: [{
                        label: 'ç”¨æˆ·æ•°',
                        data: [
                            funnelCounts.launch,
                            funnelCounts.chap1_start,
                            funnelCounts.chap1_end,
                            funnelCounts.game_end
                        ],
                        backgroundColor: ['#3498db', '#2980b9', '#8e44ad', '#27ae60'],
                        barPercentage: 0.6
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bar chart acting as funnel
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    const prevValue = context.dataIndex > 0 ? context.dataset.data[context.dataIndex - 1] : value;
                                    const conversion = context.dataIndex > 0 ? Math.round((value / prevValue) * 100) : 100;
                                    return `${value} (è½¬åŒ–ç‡: ${conversion}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // --- 2. Chapter Data ---
            // å‡†å¤‡æ•°æ®ï¼šç« èŠ‚å¼€å§‹ vs å®Œæˆ
            const chapterStarts = {};
            const chapterEnds = {};

            data.forEach(e => {
                const cid = e.chapter_id;
                if (e.event === 'chapter_start' && cid) chapterStarts[cid] = (chapterStarts[cid] || 0) + 1;
                if (e.event === 'chapter_complete' && cid) chapterEnds[cid] = (chapterEnds[cid] || 0) + 1;
            });

            const chapters = Object.keys({ ...chapterStarts, ...chapterEnds }).sort((a, b) => a - b);

            // æ¸²æŸ“æŸ±çŠ¶å›¾
            const ctx1 = document.getElementById('chapterChart').getContext('2d');
            if (chapterChartInst) chapterChartInst.destroy();

            chapterChartInst = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: chapters.map(c => `ç¬¬${c}ç« `),
                    datasets: [
                        { label: 'å¼€å§‹', data: chapters.map(c => chapterStarts[c] || 0), backgroundColor: '#36A2EB' },
                        { label: 'å®Œæˆ', data: chapters.map(c => chapterEnds[c] || 0), backgroundColor: '#4BC0C0' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // æ¸²æŸ“é¥¼å›¾ï¼šäº‹ä»¶åˆ†å¸ƒ
            const eventCounts = {};
            data.forEach(e => {
                eventCounts[e.event] = (eventCounts[e.event] || 0) + 1;
            });

            const ctx2 = document.getElementById('eventPieChart').getContext('2d');
            if (pieChartInst) pieChartInst.destroy();

            pieChartInst = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(eventCounts),
                    datasets: [{
                        data: Object.values(eventCounts),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }



        function simulateData() {
            const mockEvents = [];
            const numPlayers = 10; // Simulate 10 players

            for (let p = 0; p < numPlayers; p++) {
                const sessionId = `sess_${p}_${Date.now()}`;
                const userId = `user_00${p % 5 + 1}`;
                const baseTime = Date.now() - Math.floor(Math.random() * 86400000); // Within last 24 hours

                // Each player goes through a journey with decreasing probability of continuing
                // Launch: 100%
                mockEvents.push({
                    event: 'game_launch', event_name: 'game_launch',
                    user_id: userId, session_id: sessionId,
                    timestamp: baseTime, chapter_id: 0
                });

                // Chapter 1 Start: 90%
                if (Math.random() < 0.9) {
                    mockEvents.push({
                        event: 'chapter_start', event_name: 'chapter_start',
                        user_id: userId, session_id: sessionId,
                        timestamp: baseTime + 5000, chapter_id: 1
                    });

                    // Chapter 1 Complete: 70%
                    if (Math.random() < 0.7) {
                        mockEvents.push({
                            event: 'chapter_complete', event_name: 'chapter_complete',
                            user_id: userId, session_id: sessionId,
                            timestamp: baseTime + 60000, chapter_id: 1
                        });

                        // Game Complete: 40%
                        if (Math.random() < 0.4) {
                            mockEvents.push({
                                event: 'game_complete', event_name: 'game_complete',
                                user_id: userId, session_id: sessionId,
                                timestamp: baseTime + 300000, chapter_id: 8, score: Math.floor(Math.random() * 100)
                            });
                        }
                    }
                }
            }

            // Save to local storage
            localStorage.setItem('velotric_analytics_local', JSON.stringify(mockEvents));

            // Reload
            renderDashboard();
            alert(`å·²æ¨¡æ‹Ÿ ${numPlayers} ä¸ªç©å®¶çš„æ¸¸æˆæµç¨‹ï¼(å…± ${mockEvents.length} æ¡äº‹ä»¶)`);
        }

        function clearData() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ')) {
                Analytics.clearLocalData();
                renderDashboard();
            }
        }

        async function clearRemoteData() {
            if (!confirm('âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¿œç¨‹ Supabase æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            try {
                const supabaseClient = Analytics._supabase;
                if (!supabaseClient) {
                    alert('âŒ Supabase æœªè¿æ¥ï¼Œæ— æ³•æ¸…ç©ºè¿œç¨‹æ•°æ®');
                    return;
                }

                const { error } = await supabaseClient
                    .from('game_events')
                    .delete()
                    .not('event_name', 'is', null); // åˆ é™¤æ‰€æœ‰ event_name ä¸ä¸º null çš„æ•°æ®

                if (error) {
                    alert('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message);
                    console.error('[Dashboard] Clear remote error:', error);
                } else {
                    alert('âœ… è¿œç¨‹æ•°æ®å·²æ¸…ç©ºï¼');
                    renderDashboard();
                }
            } catch (e) {
                alert('âŒ æ¸…ç©ºå¤±è´¥: ' + e.message);
                console.error('[Dashboard] Clear remote exception:', e);
            }
        }

        // Init
        renderDashboard();
    </script>
</body>

</html>