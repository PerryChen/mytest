<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®çœ‹æ¿ | Velotric æ¸¸æˆåˆ†æ</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        html,
        body {
            overflow-y: auto !important;
            height: auto !important;
            min-height: 100vh;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 50px;
            /* Ensure space at bottom */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow-sm);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .chart-container {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            margin-bottom: 20px;
            height: 400px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }

        .data-table th {
            background: var(--bg-elevated);
            font-weight: 600;
        }

        .btn-refresh {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <header class="header">
            <div>
                <h1>ğŸ“Š æ¸¸æˆæ•°æ®çœ‹æ¿</h1>
                <p>Local Development Mode</p>
            </div>
            <div>
                <button class="btn-refresh" onclick="renderDashboard()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn btn-secondary" onclick="simulateData()">ğŸ§ª æ¨¡æ‹Ÿæ•°æ®</button>
                <button id="theme-toggle" class="btn btn-secondary" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²æ¨¡å¼">ğŸŒ“</button>
                <button class="btn btn-secondary" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæœ¬åœ°</button>
                <button class="btn btn-secondary" style="background:#dc3545" onclick="clearRemoteData()">â˜ï¸
                    æ¸…ç©ºè¿œç¨‹</button>
                <a href="../index.html" class="btn btn-ghost">è¿”å›æ¸¸æˆ</a>
            </div>
        </header>

        <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
        <div class="stats-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="stat-card">
                <div class="stat-label">æ€»äº‹ä»¶ (PV)</div>
                <div class="stat-value" id="pv-count">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ç‹¬ç«‹è®¿å®¢ (UV)</div>
                <div class="stat-value" id="uv-count">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">å¯åŠ¨æ¬¡æ•°</div>
                <div class="stat-value" id="launch-count">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ä¸»çº¿é€šå…³ç‡</div>
                <div class="stat-value" id="pass-rate">0%</div>
                <div style="font-size: 12px; color: var(--text-secondary);">game_complete / launch</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">DLC å¯åŠ¨æ•°</div>
                <div class="stat-value" id="dlc-start-count">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">DLC é€šå…³ç‡</div>
                <div class="stat-value" id="dlc-pass-rate">0%</div>
                <div style="font-size: 12px; color: var(--text-secondary);">dlc_complete / dlc_start</div>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <!-- ä¸»çº¿æ¼æ–— -->
            <div class="chart-container">
                <h3>ä¸»çº¿è½¬åŒ–æ¼æ–—</h3>
                <canvas id="funnelChart" style="max-height: 300px;"></canvas>
            </div>
            <!-- DLC æ¼æ–— -->
            <div class="chart-container">
                <h3>DLC è½¬åŒ–æ¼æ–—</h3>
                <canvas id="dlcFunnelChart" style="max-height: 300px;"></canvas>
            </div>
            <div class="chart-container">
                <h3>ä¸»çº¿ç« èŠ‚æ´»è·ƒåº¦</h3>
                <canvas id="chapterChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>DLC ç« èŠ‚æ´»è·ƒåº¦</h3>
                <canvas id="dlcChapterChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>äº‹ä»¶åˆ†å¸ƒ</h3>
                <canvas id="eventPieChart"></canvas>
            </div>
        </div>

        <!-- æœ€è¿‘äº‹ä»¶åˆ—è¡¨ -->
        <div class="chart-container" style="height: auto; overflow-x: auto;">
            <h3>æœ€è¿‘å®æ—¶äº‹ä»¶ (Latest 20)</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>äº‹ä»¶ç±»å‹</th>
                        <th>Session ID</th>
                        <th>è¯¦æƒ…</th>
                    </tr>
                </thead>
                <tbody id="event-log-body">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="../config.js"></script>
    <script src="../core/AnalyticsManager.js"></script>
    <script src="../admin_theme.js"></script>
    <script>
        const Analytics = AnalyticsManager;
        Analytics.init();

        // ---------- helpers ----------
        const sid = e => e.session_id || e.sessionId;
        const isDLCChapter = id => typeof id === 'string' && id.startsWith('dlc_');
        const dlcChapterLabel = id => {
            // "dlc_hr_onboarding_3" â†’ "HR-3"
            const m = String(id).match(/^dlc_(.+?)_(\d+)$/);
            if (!m) return id;
            const names = { hr_onboarding: 'HR' };
            return `${names[m[1]] || m[1]}-${m[2]}`;
        };
        const funnelTooltip = {
            callbacks: {
                label(ctx) {
                    const v = ctx.raw;
                    const prev = ctx.dataIndex > 0 ? ctx.dataset.data[ctx.dataIndex - 1] : v;
                    const pct = ctx.dataIndex > 0 ? Math.round((v / prev) * 100) : 100;
                    return `${v} (è½¬åŒ–ç‡: ${pct}%)`;
                }
            }
        };

        // ---------- render ----------
        async function renderDashboard() {
            const tbody = document.getElementById('event-log-body');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">Loading...</td></tr>';

            let data = await Analytics.getRemoteData();
            if (!data || data.length === 0) {
                data = Analytics.getLocalData().reverse();
                document.querySelector('.header p').textContent = 'Local Development Mode';
            } else {
                document.querySelector('.header p').textContent = 'Remote Data Mode (Supabase)';
            }

            // --- KPI cards ---
            const launches = data.filter(e => e.event === 'game_launch').length;
            const uniqueUsers = new Set(data.map(e => e.user_id)).size;
            const gameCompletes = data.filter(e => e.event === 'game_complete').length;
            const dlcStarts = data.filter(e => e.event === 'dlc_start').length;
            const dlcCompletes = data.filter(e => e.event === 'dlc_complete').length;

            document.getElementById('pv-count').textContent = data.length;
            document.getElementById('uv-count').textContent = uniqueUsers;
            document.getElementById('launch-count').textContent = launches;
            document.getElementById('pass-rate').textContent = launches > 0 ? ((gameCompletes / launches) * 100).toFixed(1) + '%' : '0%';
            document.getElementById('dlc-start-count').textContent = dlcStarts;
            document.getElementById('dlc-pass-rate').textContent = dlcStarts > 0 ? ((dlcCompletes / dlcStarts) * 100).toFixed(1) + '%' : '0%';

            // --- event log table ---
            tbody.innerHTML = '';
            data.slice(0, 20).forEach(e => {
                const tr = document.createElement('tr');
                const ts = e.timestamp || e.client_timestamp;
                const time = ts ? new Date(ts).toLocaleTimeString() : 'N/A';
                let details = '';
                const skip = new Set(['event','sessionId','userId','timestamp','_id','event_name','session_id','user_id','client_timestamp','properties']);
                Object.keys(e).forEach(k => {
                    if (!skip.has(k) && e[k] !== undefined) {
                        const v = Array.isArray(e[k]) ? e[k].join(', ') : e[k];
                        details += `${k}: ${v} | `;
                    }
                });
                const fullSid = sid(e) || 'N/A';
                tr.innerHTML = `
                    <td>${time}</td>
                    <td><span style="font-weight:bold; color:var(--primary)">${e.event}</span></td>
                    <td style="font-family:monospace;font-size:0.8em"><span title="${fullSid}" style="cursor:help;border-bottom:1px dashed #999">${fullSid.substring(0,12)}...</span></td>
                    <td style="font-size:0.9em;color:var(--text-secondary);white-space:pre-wrap">${details}</td>`;
                tbody.appendChild(tr);
            });

            renderCharts(data);
        }

        // ---------- charts ----------
        let chapterChartInst = null, dlcChapterChartInst = null;
        let pieChartInst = null;
        let funnelChartInst = null, dlcFunnelChartInst = null;

        function renderCharts(data) {
            // === 1. Main funnel ===
            const mainFunnel = {
                launch: new Set(data.filter(e => e.event === 'game_launch').map(sid)).size,
                ch1_start: new Set(data.filter(e => e.event === 'chapter_start' && e.chapter_id == 1).map(sid)).size,
                ch1_end: new Set(data.filter(e => e.event === 'chapter_complete' && e.chapter_id == 1).map(sid)).size,
                complete: new Set(data.filter(e => e.event === 'game_complete').map(sid)).size
            };
            const ctxF = document.getElementById('funnelChart').getContext('2d');
            if (funnelChartInst) funnelChartInst.destroy();
            funnelChartInst = new Chart(ctxF, {
                type: 'bar',
                data: {
                    labels: ['å¯åŠ¨', 'å¼€å§‹ç¬¬1ç« ', 'å®Œæˆç¬¬1ç« ', 'ä¸»çº¿é€šå…³'],
                    datasets: [{ label: 'ç”¨æˆ·æ•°', data: Object.values(mainFunnel), backgroundColor: ['#3498db','#2980b9','#8e44ad','#27ae60'], barPercentage: 0.6 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: funnelTooltip } }
            });

            // === 2. DLC funnel ===
            const dlcFunnel = {
                start: new Set(data.filter(e => e.event === 'dlc_start').map(sid)).size,
                ch1_start: new Set(data.filter(e => e.event === 'dlc_chapter_start' && e.chapter_index === 0).map(sid)).size,
                ch1_end: new Set(data.filter(e => e.event === 'chapter_complete' && isDLCChapter(e.chapter_id)).map(sid)).size,
                complete: new Set(data.filter(e => e.event === 'dlc_complete').map(sid)).size
            };
            const ctxDF = document.getElementById('dlcFunnelChart').getContext('2d');
            if (dlcFunnelChartInst) dlcFunnelChartInst.destroy();
            dlcFunnelChartInst = new Chart(ctxDF, {
                type: 'bar',
                data: {
                    labels: ['DLC å¯åŠ¨', 'å¼€å§‹ç¬¬1ç« ', 'å®Œæˆä»»æ„ç« ', 'DLC é€šå…³'],
                    datasets: [{ label: 'ç”¨æˆ·æ•°', data: Object.values(dlcFunnel), backgroundColor: ['#e67e22','#d35400','#c0392b','#16a085'], barPercentage: 0.6 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: funnelTooltip } }
            });

            // === 3. Main chapter activity ===
            const mainStarts = {}, mainEnds = {};
            data.forEach(e => {
                const cid = e.chapter_id;
                if (!cid || isDLCChapter(cid)) return;
                if (e.event === 'chapter_start') mainStarts[cid] = (mainStarts[cid] || 0) + 1;
                if (e.event === 'chapter_complete') mainEnds[cid] = (mainEnds[cid] || 0) + 1;
            });
            const mainChs = Object.keys({ ...mainStarts, ...mainEnds }).sort((a, b) => a - b);
            const ctx1 = document.getElementById('chapterChart').getContext('2d');
            if (chapterChartInst) chapterChartInst.destroy();
            chapterChartInst = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: mainChs.map(c => `ç¬¬${c}ç« `),
                    datasets: [
                        { label: 'å¼€å§‹', data: mainChs.map(c => mainStarts[c] || 0), backgroundColor: '#36A2EB' },
                        { label: 'å®Œæˆ', data: mainChs.map(c => mainEnds[c] || 0), backgroundColor: '#4BC0C0' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // === 4. DLC chapter activity ===
            const dlcStarts = {}, dlcEnds = {};
            data.forEach(e => {
                const cid = e.chapter_id;
                if (e.event === 'dlc_chapter_start' && cid) dlcStarts[cid] = (dlcStarts[cid] || 0) + 1;
                if (e.event === 'chapter_complete' && isDLCChapter(cid)) dlcEnds[cid] = (dlcEnds[cid] || 0) + 1;
            });
            const dlcChs = Object.keys({ ...dlcStarts, ...dlcEnds }).sort();
            const ctx3 = document.getElementById('dlcChapterChart').getContext('2d');
            if (dlcChapterChartInst) dlcChapterChartInst.destroy();
            dlcChapterChartInst = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: dlcChs.map(dlcChapterLabel),
                    datasets: [
                        { label: 'å¼€å§‹', data: dlcChs.map(c => dlcStarts[c] || 0), backgroundColor: '#e67e22' },
                        { label: 'å®Œæˆ', data: dlcChs.map(c => dlcEnds[c] || 0), backgroundColor: '#16a085' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // === 5. Event distribution pie ===
            const eventCounts = {};
            data.forEach(e => { eventCounts[e.event] = (eventCounts[e.event] || 0) + 1; });
            const ctx2 = document.getElementById('eventPieChart').getContext('2d');
            if (pieChartInst) pieChartInst.destroy();
            pieChartInst = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(eventCounts),
                    datasets: [{ data: Object.values(eventCounts), backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#e67e22','#1abc9c','#e74c3c','#95a5a6'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // ---------- simulate ----------
        function simulateData() {
            const mockEvents = [];
            const numPlayers = 10;

            for (let p = 0; p < numPlayers; p++) {
                const sessionId = `sess_${p}_${Date.now()}`;
                const userId = `user_00${p % 5 + 1}`;
                const baseTime = Date.now() - Math.floor(Math.random() * 86400000);

                // -- Main game journey --
                mockEvents.push({ event: 'game_launch', event_name: 'game_launch', user_id: userId, session_id: sessionId, timestamp: baseTime });

                if (Math.random() < 0.9) {
                    mockEvents.push({ event: 'chapter_start', event_name: 'chapter_start', user_id: userId, session_id: sessionId, timestamp: baseTime + 5000, chapter_id: 1 });
                    if (Math.random() < 0.7) {
                        mockEvents.push({ event: 'chapter_complete', event_name: 'chapter_complete', user_id: userId, session_id: sessionId, timestamp: baseTime + 60000, chapter_id: 1 });
                        if (Math.random() < 0.4) {
                            mockEvents.push({ event: 'game_complete', event_name: 'game_complete', user_id: userId, session_id: sessionId, timestamp: baseTime + 300000, score: 400 + Math.floor(Math.random() * 400) });
                        }
                    }
                }

                // -- DLC journey (60% of players try DLC) --
                if (Math.random() < 0.6) {
                    const dlcBase = baseTime + 400000;
                    mockEvents.push({ event: 'dlc_start', event_name: 'dlc_start', user_id: userId, session_id: sessionId, timestamp: dlcBase, dlc_id: 'hr_onboarding' });

                    const dlcChapters = 6;
                    let survived = true;
                    for (let c = 1; c <= dlcChapters && survived; c++) {
                        const chId = `dlc_hr_onboarding_${c}`;
                        mockEvents.push({ event: 'dlc_chapter_start', event_name: 'dlc_chapter_start', user_id: userId, session_id: sessionId, timestamp: dlcBase + c * 30000, dlc_id: 'hr_onboarding', chapter_id: chId, chapter_index: c - 1 });

                        if (Math.random() < 0.8) {
                            const chScore = Math.random() < 0.6 ? (c <= 2 || c >= 5 ? 200 : 300) : 100;
                            mockEvents.push({ event: 'chapter_complete', event_name: 'chapter_complete', user_id: userId, session_id: sessionId, timestamp: dlcBase + c * 30000 + 20000, chapter_id: chId, dlc_id: 'hr_onboarding', chapter_score: chScore });
                        } else {
                            survived = false;
                        }
                    }

                    if (survived) {
                        const totalScore = 800 + Math.floor(Math.random() * 800);
                        const achs = totalScore >= 1600 ? ['åŸ¹è®­ä¹‹æ˜Ÿ','çŸ¥è¯†è¾¾äºº','å“ç‰Œå¤§ä½¿','ä»·å€¼è§‚æ ‡å…µ','å…¥èŒè¾¾äºº','å½©è›‹çŒäºº'] : totalScore >= 1200 ? ['çŸ¥è¯†è¾¾äºº','å“ç‰Œå¤§ä½¿'] : ['çŸ¥è¯†è¾¾äºº'];
                        mockEvents.push({ event: 'dlc_complete', event_name: 'dlc_complete', user_id: userId, session_id: sessionId, timestamp: dlcBase + 250000, dlc_id: 'hr_onboarding', score: totalScore, unlocked_cards: Math.min(8, 4 + Math.floor(Math.random() * 5)), total_cards: 8, achievements: achs });
                    }
                }
            }

            localStorage.setItem('velotric_analytics_local', JSON.stringify(mockEvents));
            renderDashboard();
            alert(`å·²æ¨¡æ‹Ÿ ${numPlayers} ä¸ªç©å®¶ï¼ˆä¸»çº¿ + DLCï¼‰ï¼å…± ${mockEvents.length} æ¡äº‹ä»¶`);
        }

        function clearData() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ')) {
                Analytics.clearLocalData();
                renderDashboard();
            }
        }

        async function clearRemoteData() {
            if (!confirm('âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰è¿œç¨‹ Supabase æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            try {
                const supabaseClient = Analytics._supabase;
                if (!supabaseClient) {
                    alert('âŒ Supabase æœªè¿æ¥ï¼Œæ— æ³•æ¸…ç©ºè¿œç¨‹æ•°æ®');
                    return;
                }

                const { error } = await supabaseClient
                    .from('game_events')
                    .delete()
                    .not('event_name', 'is', null); // åˆ é™¤æ‰€æœ‰ event_name ä¸ä¸º null çš„æ•°æ®

                if (error) {
                    alert('âŒ æ¸…ç©ºå¤±è´¥: ' + error.message);
                    console.error('[Dashboard] Clear remote error:', error);
                } else {
                    alert('âœ… è¿œç¨‹æ•°æ®å·²æ¸…ç©ºï¼');
                    renderDashboard();
                }
            } catch (e) {
                alert('âŒ æ¸…ç©ºå¤±è´¥: ' + e.message);
                console.error('[Dashboard] Clear remote exception:', e);
            }
        }

        // Init
        renderDashboard();
    </script>
</body>

</html>